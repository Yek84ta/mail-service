# مستندات جامع میل سرویس

## معرفی کلی سیستم
میل سرویس ارائه شده یک سیستم مدیریت ایمیل کامل با معماری چندلایه است که قابلیت‌های زیر را ارائه می‌دهد:

- **سیستم احراز هویت ایمن** با مدیریت کاربران و رمزهای عبور هش شده
- **مدیریت کامل چرخه حیات ایمیل** از ایجاد تا ارسال و ذخیره‌سازی
- **مدیریت گیرندگان** با قابلیت‌های پیشرفته وضعیت خواندن/حذف
- **رابط کاربری غنی** با استفاده از Swing برای نمایش و مدیریت ایمیل‌ها

## معماری کلی سیستم
سیستم از معماری سه لایه استاندارد پیروی می‌کند:

1. **لایه نمایش (Presentation Layer)**:
   - رابط کاربری Swing با کامپوننت‌های سفارشی
   - مدیریت رویدادها و تعامل کاربر

2. **لایه منطق کسب‌وکار (Business Logic Layer)**:
   - سرویس‌های کاربر و ایمیل
   - اعتبارسنجی‌ها و قوانین کسب‌وکار
   - مدیریت تراکنش‌ها

3. **لایه دسترسی به داده (Data Access Layer)**:
   - ارتباط با پایگاه داده از طریق Hibernate
   - موجودیت‌های JPA و رابط‌های Repository
   - مدیریت نشست و تراکنش‌های پایگاه داده

## تکنولوژی‌های کلیدی
- **جاوا 8+** به عنوان زبان اصلی
- **Hibernate** برای ORM و مدیریت پایگاه داده
- **Swing** برای رابط کاربری
- **MySQL** به عنوان سیستم مدیریت پایگاه داده
- **Maven** برای مدیریت وابستگی‌ها

## ویژگی‌های متمایز
1. **مدیریت پیشرفته گیرندگان**:
   - امکان حذف انتخابی ایمیل برای هر گیرنده
   - رهگیری وضعیت خوانده شدن
   - مدیریت مستقل صندوق‌های ورودی کاربران

2. **امنیت**:
   - هش کردن رمزهای عبور با الگوریتم SHA-256 و نمک تصادفی
   - اعتبارسنجی جامع ورودی‌ها
   - کنترل دسترسی سطح دقیق

3. **بهینه‌سازی‌ها**:
   - ایندکس‌گذاری هوشمند برای کوئری‌های پرتکرار
   - حذف نرم برای بازیابی اطلاعات
   - مدیریت اتصالات پایگاه داده

## جریان‌های اصلی سیستم

### جریان ارسال ایمیل
1. اعتبارسنجی گیرندگان و محتوا
2. ایجاد رکورد ایمیل اصلی
3. ایجاد رکوردهای گیرندگان
4. ثبت در پایگاه داده به صورت تراکنشی

### جریان مشاهده ایمیل
1. بررسی مجوزهای دسترسی
2. به‌روزرسانی وضعیت خوانده شدن
3. بازیابی محتوای ایمیل
4. نمایش در رابط کاربری

## راه‌اندازی و پیکربندی
سیستم نیازمند پیکربندی اولیه شامل:
- تنظیمات اتصال به پایگاه داده
- تنظیمات Connection Pool
- پیکربندی سیستم لاگینگ
- تنظیم پارامترهای امنیتی

# مستندات جامع پکیج میل سرویس

## فهرست مطالب
1. [معرفی کلی](#معرفی-کلی)
2. [معماری سیستم](#معماری-سیستم)
3. [مدل داده‌ها](#مدل-داده‌ها)
4. [سرویس‌های اصلی](#سرویس‌های-اصلی)
5. [مکانیزم‌های امنیتی](#مکانیزم‌های-امنیتی)
6. [الگوهای طراحی](#الگوهای-طراحی)
7. [محدودیت‌ها و اعتبارسنجی‌ها](#محدودیت‌ها-و-اعتبارسنجی‌ها)
8. [نمونه کدهای کاربردی](#نمونه-کدهای-کاربردی)
9. [نمودارهای کمکی](#نمودارهای-کمکی)

## معرفی کلی
پکیج `aut.ap.mail` یک سیستم مدیریت ایمیل جامع با قابلیت‌های زیر ارائه می‌دهد:

- ارسال و دریافت ایمیل
- مدیریت صندوق‌های ورودی، ارسال‌ها و سطل زباله
- پیاده‌سازی عملیات پاسخ و ارسال مجدد
- مدیریت وضعیت خوانده شدن ایمیل‌ها
- سیستم بازیابی از سطل زباله

## معماری سیستم
سیستم از معماری سه لایه استاندارد پیروی می‌کند:

```
+-------------------+
|   لایه نمایش     |
+-------------------+
         |
         v
+-------------------+
|   لایه سرویس     |
|  - MailService    |
|  - MailValidation |
+-------------------+
         |
         v
+-------------------+
| لایه دسترسی داده |
|  - MailRepository |
|  - Entities       |
+-------------------+
```

### توضیح موجودیت‌های اصلی

1. **Mail**:
   - نگهدارنده اطلاعات اصلی ایمیل
   - رابطه یک به چند با MailRecipient
   - حاوی متا داده‌های ارسال

2. **MailRecipient**:
   - مدیریت وضعیت گیرندگان
   - پیاده‌سازی با کلید مرکب (Mail + User)
   - رهگیری وضعیت خوانده شدن و حذف

3. **MailDto**:
   - الگوی DTO برای انتقال داده‌های ایمیل
   - سازنده (Builder) روان برای ایجاد نمونه‌ها

## سرویس‌های اصلی

### 1. مدیریت ایمیل‌ها
- **ارسال ایمیل جدید**:
  - اعتبارسنجی گیرندگان
  - تولید کد منحصر به فرد
  - مدیریت تراکنش‌های پایگاه داده

- **دریافت ایمیل**:
  - بررسی مجوزهای دسترسی
  - به روزرسانی وضعیت خوانده شدن

### 2. مدیریت صندوق‌ها
| صندوق        | متد مربوطه                  | فیلترهای اصلی                 |
|--------------|----------------------------|-------------------------------|
| ورودی        | `findInboxForUser()`       | isDeleted=false               |
| ارسال‌ها     | `findSentForUser()`        | isDeleted=false               |
| خوانده نشده  | `findUnreadForUser()`      | isRead=false, isDeleted=false |
| سطل زباله    | `findTrashForUser()`       | isDeleted=true                |

### 3. عملیات ویژه
- **پاسخ به ایمیل (Reply)**:
  - اضافه کردن پیشوند "Re:" به موضوع
  - تنظیم خودکار گیرندگان

- **ارسال مجدد (Forward)**:
  - اضافه کردن پیشوند "Fw:" به موضوع
  - حفظ محتوای اصلی با فرمت استاندارد

## مکانیزم‌های امنیتی

1. **اعتبارسنجی‌ها**:
   - بررسی عدم ارسال به خود (`validateNotSendingToSelf`)
   - اعتبارسنجی فرمت ایمیل گیرندگان
   - بررسی محدودیت طول فیلدها

2. **کنترل دسترسی**:
   - بررسی مالکیت ایمیل قبل از عملیات
   ```java
   boolean isSender = (mail.getSender().getId()) == (currentUser.getId());
   boolean isRecipient = mail.getRecipients().stream()
           .anyMatch(r -> r.getId() == currentUser.getId());
   ```

3. **مدیریت تراکنش‌ها**:
   - استفاده از الگوی Transaction Owner
   - Rollback خودکار در صورت خطا

## الگوهای طراحی

1. **Repository Pattern**:
   - جداسازی کامل منطق دسترسی به داده‌ها
   - متدهای استاندارد CRUD

2. **Builder Pattern**:
   - در کلاس MailDto برای ساخت شیء پیچیده
   ```java
   MailDto dto = MailDto.builder()
       .id(1)
       .subject("Test")
       .senderEmail("user@example.com")
       .build();
   ```

3. **DTO Pattern**:
   - انتقال داده‌های ایمیل بین لایه‌ها
   - جلوگیری از ارسال داده‌های حساس

## محدودیت‌ها و اعتبارسنجی‌ها

| مورد                 | محدودیت                  | متد اعتبارسنجی            |
|----------------------|-------------------------|--------------------------|
| طول موضوع            | حداکثر 255 کاراکتر      | `validateSubject()`      |
| طول متن ایمیل        | حداکثر 10000 کاراکتر    | `validateBody()`         |
| تعداد گیرندگان       | حداکثر 50 نفر           | `validateRecipients()`   |
| فرمت ایمیل           | استاندارد RFC 5322      | الگوی REGEX              |
| تاریخ ارسال          | نمی‌تواند در آینده باشد | `validateSentDate()`     |


# مستندات پکیج احراز هویت کاربر

## معرفی

این پکیج امکانات احراز هویت کاربران را برای سرویس میل (Milo) فراهم می‌کند، شامل:

- ثبت نام کاربر
- ورود به سیستم
- مدیریت گذرواژه‌ها

## ساختار پکیج

```
aut.ap.user/
├── PasswordHasher.java      - مدیریت هش کردن و تأیید گذرواژه
├── User.java                - موجودیت کاربر در سیستم
├── UserRepository.java      - لایه دسترسی به داده‌های کاربر
├── UserService.java         - منطق کسب و کار کاربران
└── UserValidation.java      - ابزارهای اعتبارسنجی اطلاعات کاربر
```

## اجزای اصلی

### 1. PasswordHasher

مسئول هش کردن امن گذرواژه‌ها با استفاده از SHA-256 و نمک (salt).

**ویژگی‌ها:**
- تولید نمک تصادفی برای هر گذرواژه
- استفاده از الگوریتم SHA-256
- ذخیره نمک و هش به صورت ترکیبی (نمک:هش)
- امکان تأیید گذرواژه

### 2. موجودیت User

نمایش دهنده کاربر در سیستم با حاشیه‌نویسی‌های JPA برای ذخیره در پایگاه داده.

**فیلدها:**
- `id`: شناسه یکتا (تولید خودکار)
- `name`: نام کامل کاربر
- `email`: آدرس ایمیل یکتا (برای ورود به سیستم)
- `passwordHash`: گذرواژه هش شده با نمک

### 3. UserRepository

لایه دسترسی به داده‌ها برای عملیات کاربران.

**متدها:**
- `save()`: ذخیره کاربر جدید
- `findByEmail()`: یافتن کاربر با ایمیل
- `findById()`: یافتن کاربر با شناسه
- `existsByEmail()`: بررسی وجود ایمیل در سیستم

### 4. UserService

لایه منطق کسب و کار برای عملیات کاربران.

**عملکرد اصلی:**
- `registerUser()`: ثبت نام کاربر جدید
  - اعتبارسنجی ایمیل، گذرواژه و نام
  - بررسی تکراری نبودن ایمیل
  - هش کردن گذرواژه قبل از ذخیره
- `loginUser()`: احراز هویت کاربر
  - تأیید ایمیل و گذرواژه
  - برگرداندن کاربر در صورت تطابق
- `findByEmail()`: یافتن کاربر با ایمیل

### 5. UserValidation

اعتبارسنجی اطلاعات کاربر.

**قوانین اعتبارسنجی:**
- **ایمیل**:
  - نباید خالی باشد
  - باید قالب استاندارد ایمیل را داشته باشد
- **گذرواژه**:
  - حداقل ۸ کاراکتر
  - حداقل یک عدد
  - حداقل یک حرف کوچک
  - حداقل یک حرف بزرگ
- **نام**:
  - نباید خالی باشد

# Milou Mail Service - مستندات فنی جامع

## ویژگی‌های کلیدی

### مدیریت کاربران
- سیستم احراز هویت ایمن
- ثبت نام کاربر جدید با اعتبارسنجی
- فرمت خودکار ایمیل (پشتیبانی از both@milou.com و milou@domain.com)
- مدیریت نشست کاربر

### عملکردهای ایمیل
- **ارسال ایمیل**:
  - پشتیبانی از چندین دریافت کننده
  - اعتبارسنجی گیرنده‌ها
  - تولید کد منحصر به فرد برای هر ایمیل
- **مدیریت ایمیل‌ها**:
  - صندوق ورودی با قابلیت فیلتر (خوانده شده/نشده)
  - ایمیل‌های ارسالی
  - سطل زباله با امکان بازیابی
- **عملیات روی ایمیل**:
  - پاسخ (Reply) با حفظ تاریخچه
  - ارسال مجدد (Forward)
  - علامت گذاری به عنوان خوانده شده
  - حذف و بازیابی

### رابط کاربری
- طراحی واکنش‌گرا با Swing
- نمایش لیست ایمیل‌ها با رندرر سفارشی
- سیستم تمیز و رنگارنگ
- نمایش جزئیات کامل هر ایمیل

## معماری سیستم

### دیاگرام معماری
```
+-------------------+     +-------------------+     +-------------------+
|   Presentation    |     |    Business       |     |    Data Access    |
|   Layer (GUI)     |<--->|    Logic Layer    |<--->|    Layer          |
+-------------------+     +-------------------+     +-------------------+
        |                                                  |
        |                                                  |
        v                                                  v
+-------------------+                             +-------------------+
|    Swing UI       |                             |    Database       |
|   Components      |                             |    (via Hibernate)|
+-------------------+                             +-------------------+
```

### لایه‌های سیستم
1. **لایه نمایش (Presentation)**:
   - `Application.java`: کلاس اصلی رابط کاربری
   - `ContentPanel.java`: مدیریت محتوای اصلی
   - `SidebarPanel.java`: نوار کناری برنامه
   - `MailListRenderer.java`: رندرر سفارشی لیست ایمیل‌ها

2. **لایه منطق کسب‌وکار**:
   - `MailService.java`: سرویس‌های مربوط به ایمیل
   - `UserService.java`: سرویس‌های مربوط به کاربران

3. **لایه دسترسی به داده**:
   - `HibernateUtil.java`: تنظیمات Hibernate
   - DAOهای اختصاصی

## جزئیات پیاده‌سازی

### Application.java
کلاس اصلی برنامه که مسئولیت‌های زیر را بر عهده دارد:
- مدیریت چرخه حیات برنامه
- نمایش صفحات ورود و ثبت نام
- مدیریت وضعیت کاربر جاری
- هماهنگی بین کامپوننت‌های مختلف
- مدیریت رویدادها و تعاملات کاربر

**متدهای کلیدی**:
- `initializeLoginScreen()`: ایجاد رابط کاربری ورود
- `initializeMainApplication()`: راه‌اندازی رابط اصلی پس از ورود
- `handleLogin()/handleSignup()`: مدیریت احراز هویت
- `loadInbox()/loadSentMails()/loadTrashMails()`: بارگذاری انواع ایمیل‌ها
- `showMailContent()`: نمایش محتوای کامل ایمیل

### ContentPanel.java
پنل پویای نمایش محتوا با قابلیت‌های:
- نمایش صفحه خوش‌آمدگویی
- تعویض پویای محتوا با متد `setContent()`
- پشتیبانی از اسکرول

### SidebarPanel.java
نوار کناری شامل دکمه‌های اصلی با ویژگی‌های:
- طراحی واکنش‌گرا
- رنگ‌بندی معنادار برای هر بخش
- ترازبندی مناسب

### MailListRenderer.java
رندرر سفارشی برای JList با ویژگی‌های:
- نمایش چهار بخش اطلاعات: موضوع، فرستنده، تاریخ و وضعیت
- تمایز ایمیل‌های خوانده نشده (بولد و برچسب NEW)
- رنگ‌بندی مناسب برای حالت انتخاب شده

## مستندات فنی

### مدل‌های داده
- **MailDto**: مدل انتقال داده برای نمایش ایمیل‌ها در لیست
- **User**: مدل کاربران سیستم

### سرویس‌ها
- **MailService**: عملیات مربوط به ایمیل‌ها
- **UserService**: عملیات مربوط به کاربران

### کامپوننت‌های UI
- **JList**: برای نمایش لیست ایمیل‌ها با رندرر سفارشی
- **JTabbedPane**: برای تب‌های ورود/ثبت نام
- **JTextArea**: برای محتوای ایمیل با قابلیت خط‌شکنی

## لاگ‌گیری و عیب‌یابی
سیستم از java.util.logging برای لاگ‌گیری استفاده می‌کند:
- لاگ‌ها در فایل `milou.log` ذخیره می‌شوند
- سطح لاگ‌گیری: INFO به بالا
- فرمت لاگ: تاریخ + سطح + پیام + استک تریس


# مستندات پایگاه داده سرویس ایمیل

## ساختار پایگاه داده
# **ریدمی حرفه‌ای برای فایل دیتابیس میل سرویس**  

## ** معرفی**  
این فایل SQL بخشی از یک **سرویس ایمیل (Mail Service)** است که ساختار دیتابیس مورد نیاز برای مدیریت کاربران، ایمیل‌های ارسالی و دریافت‌کنندگان را تعریف می‌کند.  

---

## ** ساختار دیتابیس**  
### **1. جدول `users`**  
- **کاربرد:** ذخیره‌سازی اطلاعات کاربران  
- **فیلدها:**  
  - `id` (کلید اصلی)  
  - `name` (نام کاربر)  
  - `email` (آدرس ایمیل، منحصربه‌فرد)  
  - `password_hash` (رمز عبور هش‌شده)  
  - `created_at` و `updated_at` (تاریخ ایجاد و آخرین تغییر)  

### **2. جدول `mails`**  
- **کاربرد:** ذخیره‌سازی ایمیل‌های ارسال‌شده  
- **فیلدها:**  
  - `id` (کلید اصلی)  
  - `code` (کد یکتا برای شناسایی ایمیل)  
  - `sender_id` (ارسال‌کننده، با کلید خارجی به `users.id`)  
  - `subject` (موضوع ایمیل)  
  - `body` (متن ایمیل)  
  - `sent_date` (تاریخ ارسال)  
  - `is_deleted` (آیا ایمیل حذف شده؟)  
  - `deleted_at` و `deleted_by_id` (تاریخ حذف و کاربر حذف‌کننده)  

### **3. جدول `mail_recipients`**  
- **کاربرد:** مدیریت دریافت‌کنندگان هر ایمیل  
- **فیلدها:**  
  - `mail_id` (کلید خارجی به `mails.id`)  
  - `recipient_id` (کلید خارجی به `users.id`)  
  - `is_read` (آیا ایمیل خوانده شده؟)  
  - `is_deleted` (آیا ایمیل برای این کاربر حذف شده؟)  
  - `deleted_at` (تاریخ حذف)  
- **کلید اصلی ترکیبی:** (`mail_id`, `recipient_id`)  
- **ایندکس:** برای بهینه‌سازی کوئری‌های بررسی وضعیت خوانده‌شدن (`idx_mail_recipients_read`)  

---

## ** نکات فنی**  
 **بهینه‌سازی با ایندکس:**  
- ایندکس `idx_mail_recipients_read` برای بهبود عملکرد در بررسی وضعیت خوانده‌شدن ایمیل‌ها استفاده شده است.  

 **مدیریت حذف نرم (Soft Delete):**  
- هر دو جدول `mails` و `mail_recipients` از **حذف نرم** (`is_deleted` + `deleted_at`) پشتیبانی می‌کنند.  

 **روابط بین جداول:**  
- **ارسال‌کننده (`sender_id`)** در جدول `mails` به `users.id` متصل است.  
- **دریافت‌کنندگان (`recipient_id`)** در جدول `mail_recipients` به `users.id` متصل هستند.  

 **پاک‌سازی خودکار با `ON DELETE`:**  
- اگر کاربری حذف شود، ایمیل‌های ارسال‌شده او (`ON DELETE CASCADE`) و وضعیت دریافت‌کنندگان (`ON DELETE CASCADE`) به‌صورت خودکار پاک می‌شوند.  

---

## ** کاربرد در پروژه میل سرویس**  
🔹 **ارسال ایمیل:** ذخیره‌سازی ایمیل جدید در `mails` و ثبت دریافت‌کنندگان در `mail_recipients`.  
🔹 **صندوق ورودی:** نمایش ایمیل‌های دریافتی با وضعیت `is_read` و `is_deleted`.  
🔹 **مدیریت حذف ایمیل:** امکان حذف نرم برای ارسال‌کننده و دریافت‌کننده به‌صورت جداگانه.  

---

# HibernateUtil - ابزار اتصال به پایگاه داده با Hibernate

## توضیحات
این کلاس یک ابزار کمکی برای مدیریت اتصال به پایگاه داده با استفاده از Hibernate در برنامه‌های جاوا می‌باشد.

## ویژگی‌های کلیدی
- ایجاد و مدیریت `SessionFactory` به صورت Singleton
- پیکربندی خودکار از طریق فایل `hibernate.cfg.xml`
- مدیریت صحیح منابع با متد `shutdown()`
- خطایابی مناسب در صورت عدم موفقیت در ایجاد SessionFactory


## نکات مهم
- این کلاس به صورت thread-safe طراحی شده است.
- در برنامه‌های تحت وب، بهتر است از طریق Listener در زمان راه‌اندازی و توقف برنامه، متدهای مربوطه فراخوانی شوند.
- در صورت نیاز به پیکربندی پویا، می‌توان متد `buildSessionFactory()` را تغییر داد.

## نمونه فایل پیکربندی
فایل `hibernate.cfg.xml` باید شامل تنظیمات اتصال به پایگاه داده و ماپینگ موجودیت‌ها باشد.


# منابع پروژه میل سرویس

## پیکربندی پایگاه داده (Hibernate)

فایل `hibernate.cfg.xml` شامل تنظیمات اتصال به پایگاه داده و پیکربندی Hibernate می‌باشد:

### مشخصات اتصال به پایگاه داده
- **درایور:** MySQL (نسخه JDBC)
- **URL اتصال:** `jdbc:mysql://denali.liara.cloud:32261/mail_db`
- **نام کاربری:** root
- **رمز عبور:** محافظت شده

### تنظیمات پیشرفته
- **اندازه Connection Pool:** 5 اتصال همزمان
- **دیالکت:** MySQL8 برای سازگاری با ویژگی‌های خاص MySQL نسخه 8
- **حالت خودکار Commit:** غیرفعال برای کنترل بهتر تراکنش‌ها

### تنظیمات نمایش کوئری‌ها
- نمایش کوئری‌های SQL در خروجی
- قالب‌بندی و هایلایت کوئری‌ها برای خوانایی بهتر

### نگاشت کلاس‌های موجودیت
- User (مدل کاربر)
- Mail (مدل ایمیل)
- MailRecipient (مدل دریافت‌کنندگان ایمیل)

## پیکربندی سیستم لاگینگ (Log4j2)

فایل `log4j2.properties` تنظیمات سیستم لاگینگ پروژه را مدیریت می‌کند:

### سطوح لاگینگ
- **لاگ‌های عمومی:** سطح INFO
- **لاگ‌های Hibernate SQL:** سطح DEBUG
- **لاگ‌های پارامترهای SQL:** سطح TRACE
- **لاگ‌های اختصاصی برنامه:** سطح DEBUG

### فرمت خروجی
- نمایش زمان، نام thread، سطح لاگ، نام logger و پیام
- هایلایت سطوح مختلف لاگ برای تشخیص آسان‌تر

این تنظیمات به توسعه‌دهندگان کمک می‌کند تا:
- خطاهای پایگاه داده را به سرعت تشخیص دهند
- عملکرد کوئری‌ها را بررسی کنند
- جریان اجرای برنامه را دنبال کنند
- مشکلات احتمالی را عیب‌یابی نمایند
- 
## نکات مهم

1. **امنیت**: رمز عبور دیتابیس باید در محیط عملیاتی از طریق متغیرهای محیطی یا سرویس مدیریت رازها محافظت شود.
2. **مقیاس‌پذیری**: تنظیمات connection pool ممکن است نیاز به تنظیم دقیق‌تر بر اساس بار کاری داشته باشد.
3. **لاگ‌گیری**: در محیط تولید، سطح trace ممکن است باعث حجم بالای لاگ‌ها شود.



