# مستندات جامع پکیج میل سرویس

## فهرست مطالب
1. [معرفی کلی](#معرفی-کلی)
2. [معماری سیستم](#معماری-سیستم)
3. [مدل داده‌ها](#مدل-داده‌ها)
4. [سرویس‌های اصلی](#سرویس‌های-اصلی)
5. [مکانیزم‌های امنیتی](#مکانیزم‌های-امنیتی)
6. [الگوهای طراحی](#الگوهای-طراحی)
7. [محدودیت‌ها و اعتبارسنجی‌ها](#محدودیت‌ها-و-اعتبارسنجی‌ها)
8. [نمونه کدهای کاربردی](#نمونه-کدهای-کاربردی)
9. [نمودارهای کمکی](#نمودارهای-کمکی)

## معرفی کلی
پکیج `aut.ap.mail` یک سیستم مدیریت ایمیل جامع با قابلیت‌های زیر ارائه می‌دهد:

- ارسال و دریافت ایمیل
- مدیریت صندوق‌های ورودی، ارسال‌ها و سطل زباله
- پیاده‌سازی عملیات پاسخ و ارسال مجدد
- مدیریت وضعیت خوانده شدن ایمیل‌ها
- سیستم بازیابی از سطل زباله

## معماری سیستم
سیستم از معماری سه لایه استاندارد پیروی می‌کند:

```
+-------------------+
|   لایه نمایش     |
+-------------------+
         |
         v
+-------------------+
|   لایه سرویس     |
|  - MailService    |
|  - MailValidation |
+-------------------+
         |
         v
+-------------------+
| لایه دسترسی داده |
|  - MailRepository |
|  - Entities       |
+-------------------+
```

### توضیح موجودیت‌های اصلی

1. **Mail**:
   - نگهدارنده اطلاعات اصلی ایمیل
   - رابطه یک به چند با MailRecipient
   - حاوی متا داده‌های ارسال

2. **MailRecipient**:
   - مدیریت وضعیت گیرندگان
   - پیاده‌سازی با کلید مرکب (Mail + User)
   - رهگیری وضعیت خوانده شدن و حذف

3. **MailDto**:
   - الگوی DTO برای انتقال داده‌های ایمیل
   - سازنده (Builder) روان برای ایجاد نمونه‌ها

## سرویس‌های اصلی

### 1. مدیریت ایمیل‌ها
- **ارسال ایمیل جدید**:
  - اعتبارسنجی گیرندگان
  - تولید کد منحصر به فرد
  - مدیریت تراکنش‌های پایگاه داده

- **دریافت ایمیل**:
  - بررسی مجوزهای دسترسی
  - به روزرسانی وضعیت خوانده شدن

### 2. مدیریت صندوق‌ها
| صندوق        | متد مربوطه                  | فیلترهای اصلی                 |
|--------------|----------------------------|-------------------------------|
| ورودی        | `findInboxForUser()`       | isDeleted=false               |
| ارسال‌ها     | `findSentForUser()`        | isDeleted=false               |
| خوانده نشده  | `findUnreadForUser()`      | isRead=false, isDeleted=false |
| سطل زباله    | `findTrashForUser()`       | isDeleted=true                |

### 3. عملیات ویژه
- **پاسخ به ایمیل (Reply)**:
  - اضافه کردن پیشوند "Re:" به موضوع
  - تنظیم خودکار گیرندگان

- **ارسال مجدد (Forward)**:
  - اضافه کردن پیشوند "Fw:" به موضوع
  - حفظ محتوای اصلی با فرمت استاندارد

## مکانیزم‌های امنیتی

1. **اعتبارسنجی‌ها**:
   - بررسی عدم ارسال به خود (`validateNotSendingToSelf`)
   - اعتبارسنجی فرمت ایمیل گیرندگان
   - بررسی محدودیت طول فیلدها

2. **کنترل دسترسی**:
   - بررسی مالکیت ایمیل قبل از عملیات
   ```java
   boolean isSender = (mail.getSender().getId()) == (currentUser.getId());
   boolean isRecipient = mail.getRecipients().stream()
           .anyMatch(r -> r.getId() == currentUser.getId());
   ```

3. **مدیریت تراکنش‌ها**:
   - استفاده از الگوی Transaction Owner
   - Rollback خودکار در صورت خطا

## الگوهای طراحی

1. **Repository Pattern**:
   - جداسازی کامل منطق دسترسی به داده‌ها
   - متدهای استاندارد CRUD

2. **Builder Pattern**:
   - در کلاس MailDto برای ساخت شیء پیچیده
   ```java
   MailDto dto = MailDto.builder()
       .id(1)
       .subject("Test")
       .senderEmail("user@example.com")
       .build();
   ```

3. **DTO Pattern**:
   - انتقال داده‌های ایمیل بین لایه‌ها
   - جلوگیری از ارسال داده‌های حساس

## محدودیت‌ها و اعتبارسنجی‌ها

| مورد                 | محدودیت                  | متد اعتبارسنجی            |
|----------------------|-------------------------|--------------------------|
| طول موضوع            | حداکثر 255 کاراکتر      | `validateSubject()`      |
| طول متن ایمیل        | حداکثر 10000 کاراکتر    | `validateBody()`         |
| تعداد گیرندگان       | حداکثر 50 نفر           | `validateRecipients()`   |
| فرمت ایمیل           | استاندارد RFC 5322      | الگوی REGEX              |
| تاریخ ارسال          | نمی‌تواند در آینده باشد | `validateSentDate()`     |


# مستندات پکیج احراز هویت کاربر

## معرفی

این پکیج امکانات احراز هویت کاربران را برای سرویس میل (Milo) فراهم می‌کند، شامل:

- ثبت نام کاربر
- ورود به سیستم
- مدیریت گذرواژه‌ها

## ساختار پکیج

```
aut.ap.user/
├── PasswordHasher.java      - مدیریت هش کردن و تأیید گذرواژه
├── User.java                - موجودیت کاربر در سیستم
├── UserRepository.java      - لایه دسترسی به داده‌های کاربر
├── UserService.java         - منطق کسب و کار کاربران
└── UserValidation.java      - ابزارهای اعتبارسنجی اطلاعات کاربر
```

## اجزای اصلی

### 1. PasswordHasher

مسئول هش کردن امن گذرواژه‌ها با استفاده از SHA-256 و نمک (salt).

**ویژگی‌ها:**
- تولید نمک تصادفی برای هر گذرواژه
- استفاده از الگوریتم SHA-256
- ذخیره نمک و هش به صورت ترکیبی (نمک:هش)
- امکان تأیید گذرواژه

### 2. موجودیت User

نمایش دهنده کاربر در سیستم با حاشیه‌نویسی‌های JPA برای ذخیره در پایگاه داده.

**فیلدها:**
- `id`: شناسه یکتا (تولید خودکار)
- `name`: نام کامل کاربر
- `email`: آدرس ایمیل یکتا (برای ورود به سیستم)
- `passwordHash`: گذرواژه هش شده با نمک

### 3. UserRepository

لایه دسترسی به داده‌ها برای عملیات کاربران.

**متدها:**
- `save()`: ذخیره کاربر جدید
- `findByEmail()`: یافتن کاربر با ایمیل
- `findById()`: یافتن کاربر با شناسه
- `existsByEmail()`: بررسی وجود ایمیل در سیستم

### 4. UserService

لایه منطق کسب و کار برای عملیات کاربران.

**عملکرد اصلی:**
- `registerUser()`: ثبت نام کاربر جدید
  - اعتبارسنجی ایمیل، گذرواژه و نام
  - بررسی تکراری نبودن ایمیل
  - هش کردن گذرواژه قبل از ذخیره
- `loginUser()`: احراز هویت کاربر
  - تأیید ایمیل و گذرواژه
  - برگرداندن کاربر در صورت تطابق
- `findByEmail()`: یافتن کاربر با ایمیل

### 5. UserValidation

اعتبارسنجی اطلاعات کاربر.

**قوانین اعتبارسنجی:**
- **ایمیل**:
  - نباید خالی باشد
  - باید قالب استاندارد ایمیل را داشته باشد
- **گذرواژه**:
  - حداقل ۸ کاراکتر
  - حداقل یک عدد
  - حداقل یک حرف کوچک
  - حداقل یک حرف بزرگ
- **نام**:
  - نباید خالی باشد


# مستندات پایگاه داده سرویس ایمیل

## ساختار پایگاه داده

این فایل SQL ساختار پایگاه داده برای یک سرویس ایمیل را تعریف می‌کند که شامل سه جدول اصلی می‌شود:

### 1. جدول کاربران (`users`)

- **فیلدها**:
  - `id`: شناسه یکتا و خودافزای کاربر
  - `name`: نام کاربر (اجباری)
  - `email`: آدرس ایمیل (اجباری و منحصر به فرد)
  - `password_hash`: هش رمز عبور کاربر (اجباری)
  - `created_at`: زمان ایجاد حساب
  - `updated_at`: زمان آخرین به‌روزرسانی حساب

### 2. جدول ایمیل‌ها (`mails`)

- **فیلدها**:
  - `id`: شناسه یکتا و خودافزای ایمیل
  - `code`: کد منحصر به فرد ایمیل
  - `sender_id`: شناسه کاربر فرستنده (ارجاع به جدول users)
  - `subject`: موضوع ایمیل (اجباری)
  - `body`: محتوای ایمیل (اجباری)
  - `sent_date`: زمان ارسال ایمیل
  - `is_deleted`: وضعیت حذف ایمیل
  - `deleted_at`: زمان حذف ایمیل
  - `deleted_by_id`: شناسه کاربری که ایمیل را حذف کرده (ارجاع به جدول users)

- **محدودیت‌های کلید خارجی**:
  - `sender_id` به کاربران ارجاع داده می‌شود و با حذف کاربر، ایمیل‌هایش نیز حذف می‌شوند.
  - `deleted_by_id` به کاربران ارجاع داده می‌شود و با حذف کاربر، مقدار آن null می‌شود.

### 3. جدول دریافت‌کنندگان ایمیل (`mail_recipients`)

- **فیلدها**:
  - `mail_id`: شناسه ایمیل (ارجاع به جدول mails)
  - `recipient_id`: شناسه کاربر دریافت‌کننده (ارجاع به جدول users)
  - `is_read`: وضعیت خوانده شدن ایمیل

- **ویژگی‌ها**:
  - کلید اصلی ترکیبی از `mail_id` و `recipient_id`
  - با حذف ایمیل یا کاربر، رکوردهای مرتبط نیز حذف می‌شوند.
  - از موتور InnoDB استفاده می‌کند.
  - یک ایندکس برای بهبود عملکرد بررسی وضعیت خوانده شدن ایمیل‌ها ایجاد شده است.

## نکات فنی

- از قابلیت‌های TIMESTAMP برای مدیریت خودکار زمان ایجاد و به‌روزرسانی رکوردها استفاده شده است.
- رابطه‌های بین جداول به دقت تعریف شده‌اند و از کلیدهای خارجی با رفتارهای مناسب (CASCADE و SET NULL) استفاده شده است.
- ایندکس‌های مناسب برای بهبود عملکرد پرس‌وجوها ایجاد شده‌اند.



# HibernateUtil - ابزار اتصال به پایگاه داده با Hibernate

## توضیحات
این کلاس یک ابزار کمکی برای مدیریت اتصال به پایگاه داده با استفاده از Hibernate در برنامه‌های جاوا می‌باشد.

## ویژگی‌های کلیدی
- ایجاد و مدیریت `SessionFactory` به صورت Singleton
- پیکربندی خودکار از طریق فایل `hibernate.cfg.xml`
- مدیریت صحیح منابع با متد `shutdown()`
- خطایابی مناسب در صورت عدم موفقیت در ایجاد SessionFactory


## نکات مهم
- این کلاس به صورت thread-safe طراحی شده است.
- در برنامه‌های تحت وب، بهتر است از طریق Listener در زمان راه‌اندازی و توقف برنامه، متدهای مربوطه فراخوانی شوند.
- در صورت نیاز به پیکربندی پویا، می‌توان متد `buildSessionFactory()` را تغییر داد.

## نمونه فایل پیکربندی
فایل `hibernate.cfg.xml` باید شامل تنظیمات اتصال به پایگاه داده و ماپینگ موجودیت‌ها باشد.


# منابع پروژه میل سرویس

## پیکربندی پایگاه داده (Hibernate)

فایل `hibernate.cfg.xml` شامل تنظیمات اتصال به پایگاه داده و پیکربندی Hibernate می‌باشد:

### مشخصات اتصال به پایگاه داده
- **درایور:** MySQL (نسخه JDBC)
- **URL اتصال:** `jdbc:mysql://denali.liara.cloud:32261/mail_db`
- **نام کاربری:** root
- **رمز عبور:** محافظت شده

### تنظیمات پیشرفته
- **اندازه Connection Pool:** 5 اتصال همزمان
- **دیالکت:** MySQL8 برای سازگاری با ویژگی‌های خاص MySQL نسخه 8
- **حالت خودکار Commit:** غیرفعال برای کنترل بهتر تراکنش‌ها

### تنظیمات نمایش کوئری‌ها
- نمایش کوئری‌های SQL در خروجی
- قالب‌بندی و هایلایت کوئری‌ها برای خوانایی بهتر

### نگاشت کلاس‌های موجودیت
- User (مدل کاربر)
- Mail (مدل ایمیل)
- MailRecipient (مدل دریافت‌کنندگان ایمیل)

## پیکربندی سیستم لاگینگ (Log4j2)

فایل `log4j2.properties` تنظیمات سیستم لاگینگ پروژه را مدیریت می‌کند:

### سطوح لاگینگ
- **لاگ‌های عمومی:** سطح INFO
- **لاگ‌های Hibernate SQL:** سطح DEBUG
- **لاگ‌های پارامترهای SQL:** سطح TRACE
- **لاگ‌های اختصاصی برنامه:** سطح DEBUG

### فرمت خروجی
- نمایش زمان، نام thread، سطح لاگ، نام logger و پیام
- هایلایت سطوح مختلف لاگ برای تشخیص آسان‌تر

این تنظیمات به توسعه‌دهندگان کمک می‌کند تا:
- خطاهای پایگاه داده را به سرعت تشخیص دهند
- عملکرد کوئری‌ها را بررسی کنند
- جریان اجرای برنامه را دنبال کنند
- مشکلات احتمالی را عیب‌یابی نمایند
- 
## نکات مهم

1. **امنیت**: رمز عبور دیتابیس باید در محیط عملیاتی از طریق متغیرهای محیطی یا سرویس مدیریت رازها محافظت شود.
2. **مقیاس‌پذیری**: تنظیمات connection pool ممکن است نیاز به تنظیم دقیق‌تر بر اساس بار کاری داشته باشد.
3. **لاگ‌گیری**: در محیط تولید، سطح trace ممکن است باعث حجم بالای لاگ‌ها شود.


